<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forma Medical Admin Portal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #1e3d6f 0%, #2c5aa0 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .login-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            padding: 50px;
            width: 100%;
            max-width: 500px;
            margin: 5% auto;
            text-align: center;
            display: block;
        }

        .admin-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            padding: 30px;
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            display: none;
        }

        .logo {
            height: 80px;
            width: auto;
            margin-bottom: 30px;
            max-width: 100%;
        }

        .login-title {
            color: #2c5aa0;
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .login-subtitle {
            color: #666;
            font-size: 18px;
            margin-bottom: 40px;
        }

        .form-group {
            margin-bottom: 25px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c5aa0;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .form-group input {
            width: 100%;
            padding: 15px 20px;
            border: 3px solid #e1e8ed;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #2c5aa0;
            box-shadow: 0 0 0 4px rgba(44, 90, 160, 0.1);
            transform: translateY(-2px);
        }

        .login-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #2c5aa0 0%, #1e3d6f 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(44, 90, 160, 0.3);
        }

        .login-btn:hover {
            background: linear-gradient(135deg, #1e3d6f 0%, #2c5aa0 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(44, 90, 160, 0.4);
        }

        .error-message {
            background: #dc3545;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            margin-top: 20px;
            font-weight: bold;
            display: none;
        }

        /* Admin Dashboard Styles */
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #f1f3f4;
        }

        .admin-logo {
            height: 60px;
            width: auto;
        }

        .admin-title {
            color: #2c5aa0;
            font-size: 28px;
            font-weight: bold;
        }

        .admin-user {
            color: #666;
            font-size: 14px;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin-left: 15px;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        .tabs {
            display: flex;
            gap: 0;
            margin-bottom: 30px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-weight: bold;
            color: #666;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: linear-gradient(135deg, #2c5aa0 0%, #1e3d6f 100%);
            color: white;
        }

        .tab:hover:not(.active) {
            background: #e9ecef;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .distributor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .distributor-card {
            background: #f8f9fa;
            border: 2px solid #e1e8ed;
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .distributor-card:hover {
            border-color: #2c5aa0;
            box-shadow: 0 4px 15px rgba(44, 90, 160, 0.1);
        }

        .distributor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .distributor-name {
            font-size: 18px;
            font-weight: bold;
            color: #2c5aa0;
        }

        .distributor-code {
            background: #2c5aa0;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .commission-info {
            margin-bottom: 10px;
        }

        .commission-label {
            font-size: 12px;
            color: #666;
            font-weight: bold;
            text-transform: uppercase;
        }

        .commission-value {
            font-size: 16px;
            font-weight: bold;
            color: #2c5aa0;
        }

        .commission-details {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e1e8ed;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2c5aa0 0%, #1e3d6f 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .add-distributor-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }

        .add-distributor-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-title {
            color: #2c5aa0;
            font-size: 24px;
            font-weight: bold;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #666;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-col {
            flex: 1;
        }

        .commission-rules {
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .rule-header {
            font-weight: bold;
            color: #2c5aa0;
            margin-bottom: 10px;
        }

        .rule-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f1f3f4;
        }

        .rule-item:last-child {
            border-bottom: none;
        }

        .add-rule-btn {
            background: #20c997;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }

        .remove-rule-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #2c5aa0;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .distributor-grid {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .form-row {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Login Section -->
    <div id="loginContainer" class="login-container">
        <img src="Forma Medical transparent.png" alt="Forma Medical Logo" class="logo">
        
        <h1 class="login-title">Admin Portal</h1>
        <p class="login-subtitle">Forma Medical Management System</p>
        
        <form id="adminLoginForm">
            <div class="form-group">
                <label for="adminUsername">Username</label>
                <input type="text" id="adminUsername" name="adminUsername" required>
            </div>
            
            <div class="form-group">
                <label for="adminPassword">Password</label>
                <input type="password" id="adminPassword" name="adminPassword" required>
            </div>
            
            <button type="submit" class="login-btn">
                Access Admin Portal
            </button>
        </form>
        
        <div class="error-message" id="loginError">
            Invalid credentials. Please try again.
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminContainer" class="admin-container">
        <div class="admin-header">
            <div style="display: flex; align-items: center; gap: 20px;">
                <img src="Forma Medical transparent.png" alt="Forma Medical Logo" class="admin-logo">
                <h1 class="admin-title">Admin Portal</h1>
            </div>
            <div style="display: flex; align-items: center;">
                <div class="admin-user">
                    <div><strong>Welcome, Admin</strong></div>
                    <div>Forma Medical</div>
                </div>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('distributors')">Distributors</button>
            <button class="tab" onclick="showTab('commissions')">Commission Rules</button>
            <button class="tab" onclick="showTab('analytics')">Analytics</button>
            <button class="tab" onclick="showTab('settings')">Settings</button>
        </div>

        <!-- Distributors Tab -->
        <div id="distributors" class="tab-content active">
            <div class="stats-overview">
                <div class="stat-card">
                    <div class="stat-number" id="totalDistributors">0</div>
                    <div class="stat-label">Active Distributors</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalCommissions">$0</div>
                    <div class="stat-label">Monthly Commissions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgCommissionRate">0%</div>
                    <div class="stat-label">Avg Commission Rate</div>
                </div>
            </div>

            <button class="add-distributor-btn" onclick="openAddDistributorModal()">
                + Add New Distributor
            </button>

            <div class="distributor-grid" id="distributorGrid">
                <!-- Distributors will be loaded here -->
            </div>
        </div>

        <!-- Commission Rules Tab -->
        <div id="commissions" class="tab-content">
            <h2 style="color: #2c5aa0; margin-bottom: 20px;">Global Commission Settings</h2>
            <p style="color: #666; margin-bottom: 30px;">Configure default commission rates and rules for all distributors.</p>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 12px;">
                <h3 style="color: #2c5aa0; margin-bottom: 15px;">Default Rates by Procedure</h3>
                <div class="form-row">
                    <div class="form-col">
                        <label>Hammertoe Commission</label>
                        <input type="number" id="defaultHammertoe" step="0.1" min="0" max="100" value="30">
                    </div>
                    <div class="form-col">
                        <label>MTP Commission</label>
                        <input type="number" id="defaultMTP" step="0.1" min="0" max="100" value="30">
                    </div>
                    <div class="form-col">
                        <label>Lapidus Commission</label>
                        <input type="number" id="defaultLapidus" step="0.1" min="0" max="100" value="30">
                    </div>
                    <div class="form-col">
                        <label>Akin Commission</label>
                        <input type="number" id="defaultAkin" step="0.1" min="0" max="100" value="30">
                    </div>
                </div>
                <button class="btn btn-success" onclick="saveGlobalRates()">Save Global Rates</button>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics" class="tab-content">
            <h2 style="color: #2c5aa0; margin-bottom: 20px;">Commission Analytics</h2>
            <p style="color: #666; margin-bottom: 30px;">Overview of distributor performance and commission payouts.</p>
            
            <div class="stats-overview">
                <div class="stat-card">
                    <div class="stat-number">$24,580</div>
                    <div class="stat-label">Total Commissions This Month</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">156</div>
                    <div class="stat-label">Cases Processed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">$157.50</div>
                    <div class="stat-label">Avg Commission Per Case</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">32.5%</div>
                    <div class="stat-label">Avg Commission Rate</div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <h2 style="color: #2c5aa0; margin-bottom: 20px;">System Settings</h2>
            <p style="color: #666; margin-bottom: 30px;">Configure system-wide settings and preferences.</p>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 12px;">
                <h3 style="color: #2c5aa0; margin-bottom: 15px;">Payment Settings</h3>
                <div class="form-row">
                    <div class="form-col">
                        <label>Default Payment Schedule</label>
                        <select id="paymentSchedule">
                            <option value="monthly">Monthly</option>
                            <option value="quarterly">Quarterly</option>
                            <option value="immediate">Immediate</option>
                        </select>
                    </div>
                    <div class="form-col">
                        <label>Payment Processing Day</label>
                        <input type="number" id="paymentDay" min="1" max="31" value="15">
                    </div>
                </div>
                <button class="btn btn-success" onclick="saveSettings()">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Distributor Modal -->
    <div id="distributorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Add New Distributor</h2>
                <button class="close-btn" onclick="closeDistributorModal()">&times;</button>
            </div>
            
            <form id="distributorForm">
                <div class="form-row">
                    <div class="form-col">
                        <label>Company Name</label>
                        <input type="text" id="companyName" required>
                    </div>
                    <div class="form-col">
                        <label>Access Code</label>
                        <input type="text" id="accessCode" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-col">
                        <label>Contact Name</label>
                        <input type="text" id="contactName" required>
                    </div>
                    <div class="form-col">
                        <label>Email</label>
                        <input type="email" id="contactEmail" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-col">
                        <label>Phone</label>
                        <input type="tel" id="contactPhone">
                    </div>
                    <div class="form-col">
                        <label>Base Commission Rate (%)</label>
                        <input type="number" id="baseCommission" step="0.1" min="0" max="100" value="30" required>
                    </div>
                </div>

                <div class="commission-rules">
                    <div class="rule-header">Procedure-Specific Rates</div>
                    <div class="form-row">
                        <div class="form-col">
                            <label>Hammertoe (%)</label>
                            <input type="number" id="hammertoeRate" step="0.1" min="0" max="100">
                        </div>
                        <div class="form-col">
                            <label>MTP (%)</label>
                            <input type="number" id="mtpRate" step="0.1" min="0" max="100">
                        </div>
                        <div class="form-col">
                            <label>Lapidus (%)</label>
                            <input type="number" id="lapidusRate" step="0.1" min="0" max="100">
                        </div>
                        <div class="form-col">
                            <label>Akin (%)</label>
                            <input type="number" id="akinRate" step="0.1" min="0" max="100">
                        </div>
                    </div>
                </div>

                <div class="commission-rules">
                    <div class="rule-header">
                        Surgeon-Specific Rules
                        <button type="button" class="add-rule-btn" onclick="addSurgeonRule()">Add Surgeon Rule</button>
                    </div>
                    <div id="surgeonRules">
                        <!-- Surgeon rules will be added here -->
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-col">
                        <button type="submit" class="btn btn-success" style="width: 100%; padding: 15px;">
                            Save Distributor
                        </button>
                    </div>
                    <div class="form-col">
                        <button type="button" class="btn btn-warning" onclick="closeDistributorModal()" style="width: 100%; padding: 15px;">
                            Cancel
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        var currentDistributors = [];
        var editingDistributorIndex = -1;

        // Admin credentials (in real app, this would be secure backend authentication)
        var adminCredentials = {
            'admin': 'forma2025',
            'formamedical': 'admin123'
        };

        // Initialize admin portal
        window.onload = function() {
            // Check if already logged in
            if (sessionStorage.getItem('adminLoggedIn') === 'true') {
                showAdminDashboard();
            }
            
            loadDistributors();
        };

        // Login handling
        document.getElementById('adminLoginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            var username = document.getElementById('adminUsername').value;
            var password = document.getElementById('adminPassword').value;
            
            if (adminCredentials[username] && adminCredentials[username] === password) {
                sessionStorage.setItem('adminLoggedIn', 'true');
                showAdminDashboard();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        });

        function showAdminDashboard() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('adminContainer').style.display = 'block';
            loadDistributors();
            updateStats();
        }

        function logout() {
            sessionStorage.removeItem('adminLoggedIn');
            document.getElementById('loginContainer').style.display = 'block';
            document.getElementById('adminContainer').style.display = 'none';
            document.getElementById('adminLoginForm').reset();
            document.getElementById('loginError').style.display = 'none';
        }

        // Tab switching
        function showTab(tabName) {
            // Hide all tabs
            var tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(function(tab) {
                tab.classList.remove('active');
            });
            
            var tabButtons = document.querySelectorAll('.tab');
            tabButtons.forEach(function(btn) {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Load distributors from localStorage
        function loadDistributors() {
            var stored = localStorage.getItem('formaDistributors');
            if (stored) {
                currentDistributors = JSON.parse(stored);
            } else {
                // Initialize with existing distributor
                currentDistributors = [
                    {
                        companyName: 'ABC Ortho Solutions',
                        accessCode: 'ABCORTHO',
                        contactName: 'John Smith',
                        contactEmail: 'john@abcortho.com',
                        contactPhone: '555-123-4567',
                        baseCommission: 30,
                        procedureRates: {},
                        surgeonRules: [{
                            surgeonName: 'New Surgeons',
                            commissionRate: 40,
                            paymentType: 'accrued',
                            description: 'New surgeons acquired after 2025-01-01'
                        }]
                    }
                ];
                saveDistributors();
            }
            
            renderDistributors();
        }

        function saveDistributors() {
            localStorage.setItem('formaDistributors', JSON.stringify(currentDistributors));
        }

        function renderDistributors() {
            var grid = document.getElementById('distributorGrid');
            var html = '';
            
            currentDistributors.forEach(function(distributor, index) {
                var specialRules = [];
                
                // Check for procedure-specific rates
                if (distributor.procedureRates) {
                    for (var proc in distributor.procedureRates) {
                        if (distributor.procedureRates[proc] !== distributor.baseCommission) {
                            specialRules.push(proc + ': ' + distributor.procedureRates[proc] + '%');
                        }
                    }
                }
                
                // Check for surgeon rules
                if (distributor.surgeonRules && distributor.surgeonRules.length > 0) {
                    distributor.surgeonRules.forEach(function(rule) {
                        specialRules.push(rule.surgeonName + ': ' + rule.commissionRate + '%' + 
                                        (rule.paymentType === 'immediate' ? ' (immediate)' : ''));
                    });
                }
                
                html += 
                    '<div class="distributor-card">' +
                        '<div class="distributor-header">' +
                            '<div class="distributor-name">' + distributor.companyName + '</div>' +
                            '<div class="distributor-code">' + distributor.accessCode + '</div>' +
                        '</div>' +
                        '<div class="commission-info">' +
                            '<div class="commission-label">Base Commission Rate</div>' +
                            '<div class="commission-value">' + distributor.baseCommission + '%</div>' +
                        '</div>' +
                        '<div class="commission-info">' +
                            '<div class="commission-label">Contact</div>' +
                            '<div class="commission-value">' + distributor.contactName + '</div>' +
                        '</div>' +
                        (specialRules.length > 0 ? 
                            '<div class="commission-details">Special Rules: ' + specialRules.join(', ') + '</div>' : '') +
                        '<div style="margin-top: 15px; display: flex; gap: 10px;">' +
                            '<button class="btn btn-primary" onclick="editDistributor(' + index + ')">Edit</button>' +
                            '<button class="btn btn-warning" onclick="viewCommissions(' + index + ')">View Commissions</button>' +
                        '</div>' +
                    '</div>';
            });
            
            grid.innerHTML = html;
        }

        function updateStats() {
            document.getElementById('totalDistributors').textContent = currentDistributors.length;
            
            // Calculate average commission rate
            var totalRate = currentDistributors.reduce(function(sum, dist) {
                return sum + dist.baseCommission;
            }, 0);
            var avgRate = currentDistributors.length > 0 ? totalRate / currentDistributors.length : 0;
            document.getElementById('avgCommissionRate').textContent = avgRate.toFixed(1) + '%';
            
            // Mock commission total for demo
            document.getElementById('totalCommissions').textContent = ' + (currentDistributors.length * 2450).toLocaleString();
        }

        // Modal functions
        function openAddDistributorModal() {
            editingDistributorIndex = -1;
            document.getElementById('modalTitle').textContent = 'Add New Distributor';
            document.getElementById('distributorForm').reset();
            document.getElementById('surgeonRules').innerHTML = '';
            document.getElementById('distributorModal').style.display = 'block';
        }

        function editDistributor(index) {
            editingDistributorIndex = index;
            var distributor = currentDistributors[index];
            
            document.getElementById('modalTitle').textContent = 'Edit Distributor';
            document.getElementById('companyName').value = distributor.companyName;
            document.getElementById('accessCode').value = distributor.accessCode;
            document.getElementById('contactName').value = distributor.contactName;
            document.getElementById('contactEmail').value = distributor.contactEmail;
            document.getElementById('contactPhone').value = distributor.contactPhone || '';
            document.getElementById('baseCommission').value = distributor.baseCommission;
            
            // Load procedure rates
            if (distributor.procedureRates) {
                document.getElementById('hammertoeRate').value = distributor.procedureRates.Hammertoe || '';
                document.getElementById('mtpRate').value = distributor.procedureRates.MTP || '';
                document.getElementById('lapidusRate').value = distributor.procedureRates.Lapidus || '';
                document.getElementById('akinRate').value = distributor.procedureRates.Akin || '';
            }
            
            // Load surgeon rules
            var surgeonRulesContainer = document.getElementById('surgeonRules');
            surgeonRulesContainer.innerHTML = '';
            
            if (distributor.surgeonRules) {
                distributor.surgeonRules.forEach(function(rule, ruleIndex) {
                    addSurgeonRule(rule, ruleIndex);
                });
            }
            
            document.getElementById('distributorModal').style.display = 'block';
        }

        function closeDistributorModal() {
            document.getElementById('distributorModal').style.display = 'none';
        }

        function addSurgeonRule(existingRule, ruleIndex) {
            var container = document.getElementById('surgeonRules');
            var ruleId = ruleIndex !== undefined ? ruleIndex : container.children.length;
            
            var ruleDiv = document.createElement('div');
            ruleDiv.className = 'rule-item';
            ruleDiv.innerHTML = 
                '<div style="flex: 1; display: flex; gap: 10px; align-items: center;">' +
                    '<input type="text" placeholder="Surgeon Name" value="' + (existingRule ? existingRule.surgeonName : '') + '" ' +
                        'id="surgeonName_' + ruleId + '" style="flex: 1; padding: 8px;">' +
                    '<input type="number" placeholder="Rate %" value="' + (existingRule ? existingRule.commissionRate : '') + '" ' +
                        'id="surgeonRate_' + ruleId + '" step="0.1" min="0" max="100" style="width: 80px; padding: 8px;">' +
                    '<select id="paymentType_' + ruleId + '" style="padding: 8px;">' +
                        '<option value="accrued"' + (existingRule && existingRule.paymentType === 'accrued' ? ' selected' : '') + '>Accrued</option>' +
                        '<option value="immediate"' + (existingRule && existingRule.paymentType === 'immediate' ? ' selected' : '') + '>Immediate</option>' +
                    '</select>' +
                '</div>' +
                '<button type="button" class="remove-rule-btn" onclick="removeSurgeonRule(this)">Remove</button>';
            
            container.appendChild(ruleDiv);
        }

        function removeSurgeonRule(button) {
            button.parentElement.remove();
        }

        // Form submission
        document.getElementById('distributorForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            var distributorData = {
                companyName: document.getElementById('companyName').value,
                accessCode: document.getElementById('accessCode').value.toUpperCase(),
                contactName: document.getElementById('contactName').value,
                contactEmail: document.getElementById('contactEmail').value,
                contactPhone: document.getElementById('contactPhone').value,
                baseCommission: parseFloat(document.getElementById('baseCommission').value),
                procedureRates: {},
                surgeonRules: []
            };
            
            // Collect procedure rates
            var procedures = ['Hammertoe', 'MTP', 'Lapidus', 'Akin'];
            procedures.forEach(function(proc) {
                var rate = document.getElementById(proc.toLowerCase() + 'Rate').value;
                if (rate) {
                    distributorData.procedureRates[proc] = parseFloat(rate);
                }
            });
            
            // Collect surgeon rules
            var surgeonRulesContainer = document.getElementById('surgeonRules');
            for (var i = 0; i < surgeonRulesContainer.children.length; i++) {
                var surgeonName = document.getElementById('surgeonName_' + i);
                var surgeonRate = document.getElementById('surgeonRate_' + i);
                var paymentType = document.getElementById('paymentType_' + i);
                
                if (surgeonName && surgeonName.value && surgeonRate && surgeonRate.value) {
                    distributorData.surgeonRules.push({
                        surgeonName: surgeonName.value,
                        commissionRate: parseFloat(surgeonRate.value),
                        paymentType: paymentType ? paymentType.value : 'accrued'
                    });
                }
            }
            
            // Save distributor
            if (editingDistributorIndex >= 0) {
                currentDistributors[editingDistributorIndex] = distributorData;
            } else {
                currentDistributors.push(distributorData);
            }
            
            saveDistributors();
            updateDistributorLoginData();
            renderDistributors();
            updateStats();
            closeDistributorModal();
            
            alert('Distributor saved successfully!');
        });

        function updateDistributorLoginData() {
            // Update the distributor login data that the distributor portal uses
            var loginData = {};
            currentDistributors.forEach(function(dist) {
                loginData[dist.accessCode] = {
                    code: dist.accessCode,
                    companyName: dist.companyName,
                    contactName: dist.contactName,
                    email: dist.contactEmail,
                    phone: dist.contactPhone || '',
                    commissionRules: {
                        baseRate: dist.baseCommission,
                        procedureRates: dist.procedureRates,
                        surgeonRules: dist.surgeonRules
                    }
                };
            });
            
            localStorage.setItem('distributorLoginData', JSON.stringify(loginData));
        }

        function viewCommissions(index) {
            var distributor = currentDistributors[index];
            var message = 'Commission Structure for ' + distributor.companyName + ':\n\n';
            message += 'Base Rate: ' + distributor.baseCommission + '%\n';
            
            if (distributor.procedureRates && Object.keys(distributor.procedureRates).length > 0) {
                message += '\nProcedure-Specific Rates:\n';
                for (var proc in distributor.procedureRates) {
                    message += '- ' + proc + ': ' + distributor.procedureRates[proc] + '%\n';
                }
            }
            
            if (distributor.surgeonRules && distributor.surgeonRules.length > 0) {
                message += '\nSurgeon-Specific Rules:\n';
                distributor.surgeonRules.forEach(function(rule) {
                    message += '- ' + rule.surgeonName + ': ' + rule.commissionRate + '% (' + rule.paymentType + ')\n';
                });
            }
            
            alert(message);
        }

        function saveGlobalRates() {
            var globalRates = {
                Hammertoe: parseFloat(document.getElementById('defaultHammertoe').value),
                MTP: parseFloat(document.getElementById('defaultMTP').value),
                Lapidus: parseFloat(document.getElementById('defaultLapidus').value),
                Akin: parseFloat(document.getElementById('defaultAkin').value)
            };
            
            localStorage.setItem('globalCommissionRates', JSON.stringify(globalRates));
            alert('Global commission rates saved successfully!');
        }

        function saveSettings() {
            var settings = {
                paymentSchedule: document.getElementById('paymentSchedule').value,
                paymentDay: parseInt(document.getElementById('paymentDay').value)
            };
            
            localStorage.setItem('formaSettings', JSON.stringify(settings));
            alert('Settings saved successfully!');
        }

        // Close modal when clicking outside
        document.getElementById('distributorModal').addEventListener('click', function(e) {
            if (e.target === document.getElementById('distributorModal')) {
                closeDistributorModal();
            }
        });

        // Initialize with demo data if needed
        setTimeout(function() {
            updateDistributorLoginData();
        }, 1000);
    </script>
</body>
</html>
